# Multi-stage Dockerfile for AWX Execution Environment
# Generated by awx-ee-builder

# Stage 1: Build dependencies
FROM {{ base_image }} AS builder

# Install build tools and Python
RUN dnf install -y \
    python{{ python_version }} \
    python{{ python_version }}-pip \
{%- for pkg in build_packages %}
    {{ pkg }} \
{%- endfor %}
    && dnf clean all

# Upgrade pip and install build tools
RUN python{{ python_version }} -m pip install --no-cache-dir --upgrade \
    pip setuptools wheel

# Install Python packages
RUN python{{ python_version }} -m pip install --no-cache-dir \
    "ansible-core{{ ansible_core_version }}" \
{%- for pkg in python_packages %}
    "{{ pkg }}" \
{%- endfor %}
    && true

# Stage 2: Runtime environment
FROM {{ base_image }}

LABEL maintainer="vjranagit"
LABEL description="AWX Execution Environment"
LABEL version="{{ version }}"

# Install runtime dependencies
RUN dnf install -y \
    python{{ python_version }} \
{%- for pkg in system_packages %}
    {{ pkg }} \
{%- endfor %}
    && dnf clean all

# Copy Python packages from builder
COPY --from=builder /usr/local/lib/python{{ python_version }}/site-packages \
                    /usr/local/lib/python{{ python_version }}/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

{% if receptor_enabled %}
# Copy receptor binary
COPY --from={{ receptor_image }} /usr/bin/receptor /usr/bin/receptor
{% endif %}

# Install Ansible collections
RUN mkdir -p /usr/share/ansible/collections
{% for collection in collections %}
RUN ansible-galaxy collection install {{ collection.name }}{% if collection.version != "latest" %}:{{ collection.version }}{% endif %}
{% endfor %}

{% if additional_runtime_commands %}
# Additional runtime setup
{% for cmd in additional_runtime_commands %}
RUN {{ cmd }}
{% endfor %}
{% endif %}

{% if entrypoint %}
# Setup custom entrypoint
COPY {{ entrypoint }} /entrypoint.sh
RUN chmod +x /entrypoint.sh
ENTRYPOINT ["/entrypoint.sh"]
{% endif %}

# Default command
CMD [{{ default_command_args }}]

# Working directory
WORKDIR /runner

# User setup (run as non-root)
RUN useradd -u 1000 -g 0 -M -d /runner runner && \
    chown -R 1000:0 /runner && \
    chmod -R g+w /runner

USER 1000
